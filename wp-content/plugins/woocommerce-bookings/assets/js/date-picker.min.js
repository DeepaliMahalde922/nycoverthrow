jQuery(function(a){var b=0,c=new Object,d={init:function(){a("body").on("change","#wc_bookings_field_duration, #wc_bookings_field_resource",this.date_picker_init),a("body").on("click",".wc-bookings-date-picker legend small.wc-bookings-date-picker-choose-date",this.toggle_calendar),a("body").on("input",".booking_date_year, .booking_date_month, .booking_date_day",this.input_date_trigger),a("body").on("keypress",".booking_date_year, .booking_date_month, .booking_date_day",this.input_date_keypress),a("body").on("keypress",".booking_to_date_year, .booking_to_date_month, .booking_to_date_day",this.input_date_keypress),a("body").on("change",".booking_to_date_year, .booking_to_date_month, .booking_to_date_day",this.input_date_trigger),a(".wc-bookings-date-picker legend small.wc-bookings-date-picker-choose-date").show(),a(".wc-bookings-date-picker").each(function(){var b=a(this).closest("form"),c=b.find(".picker"),e=a(this).closest("fieldset");d.date_picker_init(c),"always_visible"==c.data("display")?(a(".wc-bookings-date-picker-date-fields",e).hide(),a(".wc-bookings-date-picker-choose-date",e).hide()):c.hide(),c.data("is_range_picker_enabled")&&(b.find("p.wc_bookings_field_duration").hide(),b.find(".wc_bookings_field_start_date legend span.label").text("always_visible"!==c.data("display")?booking_form_params.i18n_dates:booking_form_params.i18n_start_date))}),d.loop_availabilities()},fetch_availabilities:function(b,c){var e={action:"wc_bookings_get_availabilities",year:b.toString(),month:c.toString(),nonce:booking_form_params.get_availabilities_nonce,product_id:a(".wc-booking-product-id").val()};a.ajax({url:booking_form_params.ajax_url,data:e,type:"POST"}).done(function(a){var e=String(b+"-"+c);d.add_availability_data(e,a)})},loop_availabilities:function(){for(var b=new Date,c=b.getFullYear(),e=b.getMonth()+1,f=a(".wc-bookings-date-picker .picker").data("max_date").replace("-","").replace("m","").replace("+",""),g=0;g<=f;g++)12<e&&(c+=1,e=1),d.fetch_availabilities(c,e),e++},calc_duration:function(a){var b=a.closest("form"),c=a.closest("fieldset"),d=a.data("duration-unit");setTimeout(function(){var a=1,e=parseInt(c.find("input.booking_to_date_year").val(),10),f=parseInt(c.find("input.booking_to_date_month").val(),10),g=parseInt(c.find("input.booking_to_date_day").val(),10),h=parseInt(c.find("input.booking_date_year").val(),10),i=parseInt(c.find("input.booking_date_month").val(),10),j=parseInt(c.find("input.booking_date_day").val(),10);if(e&&f>=0&&g&&h&&i>=0&&j){var k=new Date(Date.UTC(h,i-1,j)),l=new Date(Date.UTC(e,f-1,g));a=Math.floor((l.getTime()-k.getTime())/864e5),"day"===d&&(a+=1)}b.find("#wc_bookings_field_duration").val(a).change()})},toggle_calendar:function(){$picker=a(this).closest("fieldset").find(".picker:eq(0)"),d.date_picker_init($picker),$picker.slideToggle()},input_date_keypress:function(){var c=a(this).closest("fieldset"),e=c.find(".picker:eq(0)");e.data("is_range_picker_enabled")&&(clearTimeout(b),b=setTimeout(d.calc_duration(e),800))},input_date_trigger:function(){var b=a(this).closest("fieldset"),c=b.find(".picker:eq(0)"),e=(a(this).closest("form"),parseInt(b.find("input.booking_date_year").val(),10)),f=parseInt(b.find("input.booking_date_month").val(),10),g=parseInt(b.find("input.booking_date_day").val(),10);if(e&&f&&g){var h=new Date(e,f-1,g);if(c.datepicker("setDate",h),c.data("is_range_picker_enabled")){var i=parseInt(b.find("input.booking_to_date_year").val(),10),j=parseInt(b.find("input.booking_to_date_month").val(),10),k=parseInt(b.find("input.booking_to_date_day").val(),10),l=new Date(i,j-1,k);!l||l<h?(b.find("input.booking_to_date_year").val("").addClass("error"),b.find("input.booking_to_date_month").val("").addClass("error"),b.find("input.booking_to_date_day").val("").addClass("error")):b.find("input").removeClass("error")}b.triggerHandler("date-selected",h)}},select_date_trigger:function(b){var c=a(this).closest("fieldset"),e=c.find(".picker:eq(0)"),f=a(this).closest("form"),g=b.split("-"),h=e.data("start_or_end_date");e.data("is_range_picker_enabled")&&h||(h="start"),"end"===h?(e.data("min_date",e.data("o_min_date")),c.find("input.booking_to_date_year").val(g[0]),c.find("input.booking_to_date_month").val(g[1]),c.find("input.booking_to_date_day").val(g[2]).change(),e.data("is_range_picker_enabled")&&d.calc_duration(e),e.data("start_or_end_date","start"),e.data("is_range_picker_enabled")&&f.find(".wc_bookings_field_start_date legend span.label").text("always_visible"!==e.data("display")?booking_form_params.i18n_dates:booking_form_params.i18n_start_date),"always_visible"!==e.data("display")&&a(this).hide()):(e.data("is_range_picker_enabled")&&(e.data("o_min_date",e.data("min_date")),e.data("min_date",b)),c.find("input.booking_to_date_year").val(""),c.find("input.booking_to_date_month").val(""),c.find("input.booking_to_date_day").val(""),c.find("input.booking_date_year").val(g[0]),c.find("input.booking_date_month").val(g[1]),c.find("input.booking_date_day").val(g[2]).change(),e.data("is_range_picker_enabled")&&d.calc_duration(e),e.data("start_or_end_date","end"),e.data("is_range_picker_enabled")&&f.find(".wc_bookings_field_start_date legend span.label").text(booking_form_params.i18n_end_date),"always_visible"===e.data("display")||e.data("is_range_picker_enabled")||a(this).hide()),c.triggerHandler("date-selected",b,h)},date_picker_init:function(b){var c;c=a(b).is(".picker")?a(b):a(this).closest("form").find(".picker:eq(0)"),c.empty().removeClass("hasDatepicker").datepicker({dateFormat:a.datepicker.ISO_8601,showWeek:!1,showOn:!1,beforeShowDay:d.is_bookable,onSelect:d.select_date_trigger,minDate:c.data("min_date"),maxDate:c.data("max_date"),defaultDate:c.data("default_date"),numberOfMonths:1,showButtonPanel:!1,showOtherMonths:!1,selectOtherMonths:!1,closeText:wc_bookings_booking_form.closeText,currentText:wc_bookings_booking_form.currentText,prevText:wc_bookings_booking_form.prevText,nextText:wc_bookings_booking_form.nextText,monthNames:wc_bookings_booking_form.monthNames,monthNamesShort:wc_bookings_booking_form.monthNamesShort,dayNames:wc_bookings_booking_form.dayNames,dayNamesShort:wc_bookings_booking_form.dayNamesShort,dayNamesMin:wc_bookings_booking_form.dayNamesMin,firstDay:wc_bookings_booking_form.firstDay,gotoCurrent:!0,onChangeMonthYear:d.get_availabilities});var e=c.datepicker("getDate"),g=(new Date(p),e.getFullYear()),h=e.getMonth()+1,i=String(g+"-"+h),j=a(".wc-bookings-date-picker .picker").data("availability"),k=a(".wc-bookings-date-picker .picker").data("fully-booked-days"),l=a(".wc-bookings-date-picker .picker").data("partially-booked-days"),m={availability:j,partial:l,full:k};d.add_availability_data(i,m),a(".ui-datepicker-current-day").removeClass("ui-datepicker-current-day");var n=c.closest("form"),g=parseInt(n.find("input.booking_date_year").val(),10),h=parseInt(n.find("input.booking_date_month").val(),10),o=parseInt(n.find("input.booking_date_day").val(),10);if(g&&h&&o){var p=new Date(g,h-1,o);c.datepicker("setDate",p)}},add_availability_data:function(a,b){c[a]=b},get_availability_data:function(a){return c.hasOwnProperty(a)?c[a]:""},set_availability_data:function(b){a.isEmptyObject(b)||(a(".wc-bookings-date-picker .picker").data("availability",b.availability),a(".wc-bookings-date-picker .picker").data("partially-booked-days",b.partial),a(".wc-bookings-date-picker .picker").data("fully-booked-days",b.full))},get_availabilities:function(b,c,e){var f={action:"wc_bookings_get_availabilities",year:b,month:c,nonce:booking_form_params.get_availabilities_nonce,product_id:a(".wc-booking-product-id").val()},g=String(b+"-"+c);return a.isEmptyObject(d.get_availability_data(g))?void a.ajax({url:booking_form_params.ajax_url,data:f,type:"POST",async:!1}).done(function(a){d.add_availability_data(g,a),d.set_availability_data(a)}):void d.set_availability_data(d.get_availability_data(g))},get_input_date:function(a,b){var c=a.find("input.booking_"+b+"date_year"),d=a.find("input.booking_"+b+"date_month"),e=a.find("input.booking_"+b+"date_day");return 0!==c.val().length&&0!==d.val().length&&0!==e.val().length?c.val()+"-"+d.val()+"-"+e.val():""},is_bookable:function(b){var c=a(this).closest("form"),e=c.find(".picker:eq(0)"),f=a(this).data("availability"),g=a(this).data("default-availability"),h=a(this).data("fully-booked-days"),i=a(this).data("buffer-days"),j=a(this).data("partially-booked-days"),k=wc_bookings_booking_form.check_availability_against,l="",m="",n=0,o=wc_bookings_booking_form.resources_assignment;c.find("select#wc_bookings_field_resource").val()>0&&(n=c.find("select#wc_bookings_field_resource").val());var p=wc_bookings_booking_form.booking_duration,q=new Date(b),r=q.getFullYear(),s=q.getMonth()+1,t=q.getDate();if(h[r+"-"+s+"-"+t]&&(h[r+"-"+s+"-"+t][0]||h[r+"-"+s+"-"+t][n]))return[!1,"fully_booked",booking_form_params.i18n_date_fully_booked];if("undefined"!=typeof i&&i[r+"-"+s+"-"+t])return[!1,"not_bookable",booking_form_params.i18n_date_unavailable];if(""+r+s+t<wc_bookings_booking_form.current_time)return[!1,"not_bookable",booking_form_params.i18n_date_unavailable];j&&j[r+"-"+s+"-"+t]&&(j[r+"-"+s+"-"+t][0]||j[r+"-"+s+"-"+t][n])&&(l+="partial_booked ");var u=p;if(c.find("#wc_bookings_field_duration").size()>0&&"minute"!=wc_bookings_booking_form.duration_unit&&"hour"!=wc_bookings_booking_form.duration_unit&&!e.data("is_range_picker_enabled")){var v=c.find("#wc_bookings_field_duration").val();u=p*v}(u<1||"start"===k)&&(u=1);var w={start_date:b,number_of_days:u,fully_booked_days:h,availability:f,default_availability:g,resource_id:n,resources_assignment:o},x=d.is_blocks_bookable(w);if(x){if(m=l.indexOf("partial_booked")>-1?booking_form_params.i18n_date_partially_booked:booking_form_params.i18n_date_available,e.data("is_range_picker_enabled")){var y=a(this).closest("fieldset"),z=a.datepicker.parseDate(a.datepicker.ISO_8601,d.get_input_date(y,"")),A=a.datepicker.parseDate(a.datepicker.ISO_8601,d.get_input_date(y,"to_"));return[x,z&&(b.getTime()===z.getTime()||A&&b>=z&&b<=A)?l+"bookable-range":l+"bookable",m]}return[x,l+"bookable",m]}return[x,"not_bookable",booking_form_params.i18n_date_unavailable]},is_blocks_bookable:function(b){for(var c=b.default_availability,e=0;e<b.number_of_days;e++){var f=new Date(b.start_date);f.setDate(f.getDate()+e);var g=f.getFullYear(),h=f.getMonth()+1,i=f.getDate(),j=f.getDay();a.datepicker.iso8601Week(f);0===j&&(j=7);var l={resource_rules:b.availability[b.resource_id],date:f,default_availability:b.default_availability};if(c=d.is_resource_available(l),"automatic"===b.resources_assignment){var m=a.extend({availability:b.availability,fully_booked_days:b.fully_booked_days},l);c=d.has_available_resource(m)}if(b.fully_booked_days[g+"-"+h+"-"+i]&&(b.fully_booked_days[g+"-"+h+"-"+i][0]||b.fully_booked_days[g+"-"+h+"-"+i][b.resource_id])&&(c=!1),!c)break}return c},is_resource_available:function(b){var c=b.default_availability,d=b.date.getFullYear(),e=b.date.getMonth()+1,f=b.date.getDate(),g=b.date.getDay(),h=a.datepicker.iso8601Week(b.date);return 0===g&&(g=7),!(b.fully_booked_days&&b.fully_booked_days[d+"-"+e+"-"+f]&&b.fully_booked_days[d+"-"+e+"-"+f][b.resource_id])&&(a.each(b.resource_rules,function(a,i){var j=i[0],k=i[1];try{switch(j){case"months":if("undefined"!=typeof k[e])return c=k[e],!1;break;case"weeks":if("undefined"!=typeof k[h])return c=k[h],!1;break;case"days":if("undefined"!=typeof k[g])return c=k[g],!1;break;case"custom":if("undefined"!=typeof k[d][e][f])return c=k[d][e][f],!1;break;case"time":case"time:1":case"time:2":case"time:3":case"time:4":case"time:5":case"time:6":case"time:7":!1!==b.default_availability||g!==k.day&&0!==k.day||(c=k.rule);break;case"time:range":if(!1===b.default_availability&&"undefined"!=typeof k[d][e][f])return c=k[d][e][f].rule,!1}}catch(a){}return!0}),c)},has_available_resource:function(a){for(var b in a.availability)if(b=parseInt(b,10),0!==b&&(a.resource_rules=a.availability[b],a.resource_id=b,d.is_resource_available(a)))return!0;return!1}};d.init()});